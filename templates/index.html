<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covert Compute Production Model</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 350px;
            background-color: #f5f5f5;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }

        .sidebar h1 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }

        .sidebar h2 {
            font-size: 16px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #555;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
        }

        .param-group {
            margin-bottom: 15px;
        }

        .param-group label {
            display: block;
            font-size: 13px;
            margin-bottom: 5px;
            color: #666;
        }

        .param-group input,
        .param-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
        }

        .param-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px 20px 20px 20px;
            overflow-y: auto;
        }

        .top-plots {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 10px;
            width: 100%;
        }

        .plot-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            min-width: 0; /* Allows grid items to shrink below content size */
            overflow: hidden;
        }

        .plot-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .plot {
            width: 100% !important;
            max-width: 100% !important;
            height: 364px;
        }

        .plot > div {
            width: 100% !important;
            max-width: 100% !important;
        }

        .breakdown-section {
            margin-top: 30px;
            padding: 15px 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .breakdown-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .breakdown-grid {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 20px;
            max-width: 100%;
            width: 100%;
        }

        .breakdown-item {
            text-align: center;
            min-width: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .breakdown-plot {
            height: 240px;
            width: 100%;
            max-width: 100%;
            flex: 1;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .breakdown-plot > div {
            width: 100% !important;
            max-width: 100% !important;
        }

        .breakdown-label {
            font-size: 11px;
            font-weight: bold;
            margin-top: 5px;
            color: #555;
            line-height: 1.2;
        }

        .operator {
            font-size: 24px;
            font-weight: bold;
            color: #666;
            padding: 0 3px;
            flex: 0 0 auto;
        }

        .status {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 13px;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .section-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>Model Parameters</h1>

        <button id="runSimulation">Run Simulation</button>

        <div id="status"></div>

        <h2>Simulation Settings</h2>
        <div class="param-group">
            <label for="agreement_year">Agreement start year</label>
            <input type="number" id="agreement_year" value="2030" step="0.1">
        </div>
        <div class="param-group">
            <label for="end_year">End year</label>
            <input type="number" id="end_year" value="2037" step="0.1">
        </div>
        <div class="param-group">
            <label for="increment">Time increment (years)</label>
            <input type="number" id="increment" value="0.1" step="0.01">
        </div>
        <div class="param-group">
            <label for="num_simulations">Number of simulations</label>
            <input type="number" id="num_simulations" value="300" min="1" max="10000">
        </div>

        <h2>PRC Strategy</h2>
        <div class="param-group">
            <label>
                <input type="checkbox" id="run_covert_project" checked>
                Run covert project
            </label>
        </div>
        <div class="param-group">
            <label>
                <input type="checkbox" id="build_covert_fab" checked>
                Build covert fab
            </label>
        </div>
        <div class="param-group">
            <label for="operating_labor">Number of workers to operate fab</label>
            <input type="number" id="operating_labor" value="728">
        </div>
        <div class="param-group">
            <label for="construction_labor">Number of workers to construct fab</label>
            <input type="number" id="construction_labor" value="448">
        </div>
        <div class="param-group">
            <label for="process_node">Process node</label>
            <select id="process_node">
                <option value="best_available_indigenously">Best Available Indigenously</option>
                <option value="nm130">130nm</option>
                <option value="nm28">28nm</option>
                <option value="nm14">14nm</option>
                <option value="nm7">7nm</option>
            </select>
        </div>
        <div class="param-group">
            <label for="scanner_proportion">Proportion of prc sme diverted to covert fab at start of the agreement</label>
            <input type="number" id="scanner_proportion" value="0.102" step="0.001">
        </div>

        <h2>US Prior Probabilities</h2>
        <div class="param-group">
            <label for="p_project_exists">P(Project Exists)</label>
            <input type="number" id="p_project_exists" value="0.2" step="0.01" min="0" max="1">
        </div>
        <div class="param-group">
            <label for="p_fab_exists">P(Fab Exists)</label>
            <input type="number" id="p_fab_exists" value="0.1" step="0.01" min="0" max="1">
        </div>

        <h2>Fab Model Parameters</h2>

        <h3 style="font-size: 14px; margin-top: 15px; color: #777;">Detection Parameters</h3>
        <div class="param-group">
            <label for="proportion_diverted_sme">Us intelligence estimates 50% chance of covert fab at what proportion of sme diverted</label>
            <input type="number" id="proportion_diverted_sme" value="0.14" step="0.01">
        </div>
        <div class="param-group">
            <label for="mean_detection_time_100">Expected time to detect covert project involving 100 people (years)</label>
            <input type="number" id="mean_detection_time_100" value="6.95" step="0.01">
        </div>
        <div class="param-group">
            <label for="mean_detection_time_1000">Expected time to detect covert project involving 1000 people (years)</label>
            <input type="number" id="mean_detection_time_1000" value="3.42" step="0.01">
        </div>
        <div class="param-group">
            <label for="variance_detection_time">Detection time sigma (years)</label>
            <input type="number" id="variance_detection_time" value="3.88" step="0.01">
        </div>

        <h3 style="font-size: 14px; margin-top: 15px; color: #777;">Production Capacity</h3>
        <div class="param-group">
            <label for="wafers_per_month_per_worker">Wafers/month per operating worker</label>
            <input type="number" id="wafers_per_month_per_worker" value="24.64" step="0.01">
        </div>
        <div class="param-group">
            <label for="labor_productivity_sigma">Wafers per month per operating worker sigma (log scale, wafers/month)</label>
            <input type="number" id="labor_productivity_sigma" value="0.62" step="0.01">
        </div>
        <div class="param-group">
            <label for="wafers_per_month_per_scanner">Wafers/month per photolithography scanner</label>
            <input type="number" id="wafers_per_month_per_scanner" value="1000" step="1">
        </div>
        <div class="param-group">
            <label for="scanner_productivity_sigma">Wafers per month per photolithography scanner sigma (log scale, wafers/month)</label>
            <input type="number" id="scanner_productivity_sigma" value="0.20" step="0.01">
        </div>

        <h3 style="font-size: 14px; margin-top: 15px; color: #777;">Construction Time</h3>
        <div class="param-group">
            <label for="construction_time_5k">Construction time of 5k wafers/month fab (years)</label>
            <input type="number" id="construction_time_5k" value="1.40" step="0.01">
        </div>
        <div class="param-group">
            <label for="construction_time_100k">Construction time of 100k wafers/month fab (years)</label>
            <input type="number" id="construction_time_100k" value="2.41" step="0.01">
        </div>
        <div class="param-group">
            <label for="construction_time_sigma">Construction time sigma (log scale)</label>
            <input type="number" id="construction_time_sigma" value="0.35" step="0.01">
        </div>
        <div class="param-group">
            <label for="construction_workers_per_1000">Construction workers per 1000 wafers/month</label>
            <input type="number" id="construction_workers_per_1000" value="14.1" step="0.1">
        </div>

        <h3 style="font-size: 14px; margin-top: 15px; color: #777;">Chip Production</h3>
        <div class="param-group">
            <label for="chips_per_wafer">H100-sized chips per wafer (yield)</label>
            <input type="number" id="chips_per_wafer" value="28" step="1">
        </div>
        <div class="param-group">
            <label for="transistor_density_exponent">Transistor density increase for every halving of process node</label>
            <input type="number" id="transistor_density_exponent" value="1.49" step="0.01">
        </div>
        <div class="param-group">
            <label for="architecture_efficiency">Rate of architecture efficiency improvement per year</label>
            <input type="number" id="architecture_efficiency" value="1.23" step="0.01">
        </div>

        <h3 style="font-size: 14px; margin-top: 15px; color: #777;">PRC Scanner Production</h3>
        <div class="param-group">
            <label for="prc_scanners_first_year">Prc scanners produced in first year after high volume production is achieved</label>
            <input type="number" id="prc_scanners_first_year" value="20.0" step="1">
        </div>
        <div class="param-group">
            <label for="prc_scanners_per_year">Annual increase of scanner production</label>
            <input type="number" id="prc_scanners_per_year" value="16.0" step="1">
        </div>
        <div class="param-group">
            <label for="prc_scanner_production_sigma">Prc scanner production sigma (log scale)</label>
            <input type="number" id="prc_scanner_production_sigma" value="0.30" step="0.01">
        </div>
    </div>

    <div class="main-content">
        <div class="loading active" id="loading">
            <h2>Running Simulation...</h2>
            <p>This may take a few moments.</p>
        </div>

        <div id="plots" style="display: none;">
            <div class="top-plots">
                <div class="plot-container">
                    <div class="plot-title">Covert Compute Produced Before Detection</div>
                    <div id="computeCcdfPlot" class="plot"></div>
                </div>

                <div class="plot-container">
                    <div class="plot-title">Simulation Runs Over Time</div>
                    <div id="timeSeriesPlot" class="plot"></div>
                </div>
            </div>

            <div class="breakdown-section">
                <div class="breakdown-title">Odds of Covert Project Breakdown</div>
                <div class="section-description">
                    Posterior Odds = Prior Odds × LR<sub>inventory</sub> × LR<sub>procurement</sub> × LR<sub>other</sub><br>
                    Combine prior belief with evidence from three independent intelligence sources to estimate detection likelihood.
                </div>
                <div class="breakdown-grid">
                    <div class="breakdown-item" style="flex: 0 0 140px; min-width: 140px;">
                        <div id="priorOddsDisplay" class="breakdown-plot" style="display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: #555; padding: 20px;">
                            --
                        </div>
                        <div class="breakdown-label">Prior Odds of<br>Covert Project</div>
                    </div>
                    <div class="operator">×</div>
                    <div class="breakdown-item">
                        <div id="lrInventoryPlot" class="breakdown-plot"></div>
                        <div class="breakdown-label">Likelihood Ratio from<br>Inventory Accounting</div>
                    </div>
                    <div class="operator">×</div>
                    <div class="breakdown-item">
                        <div id="lrProcurementPlot" class="breakdown-plot"></div>
                        <div class="breakdown-label">Likelihood Ratio from<br>Procurement Accounting</div>
                    </div>
                    <div class="operator">×</div>
                    <div class="breakdown-item">
                        <div id="lrOtherPlot" class="breakdown-plot"></div>
                        <div class="breakdown-label">Likelihood Ratio from Other Intelligence Sources<br>(e.g. HUMINT, SIGINT, IMINT)</div>
                    </div>
                    <div class="operator">=</div>
                    <div class="breakdown-item">
                        <div id="posteriorOddsPlot" class="breakdown-plot"></div>
                        <div class="breakdown-label">Posterior Odds of<br>Covert Project</div>
                    </div>
                </div>
            </div>

            <div class="breakdown-section">
                <div class="breakdown-title">Compute Production Rate Breakdown</div>
                <div class="section-description">
                    H100e per month = Probability Operational × Wafer Starts per Month × H100-sized Chips per Wafer × H100e per Chip × Architecture Efficiency
                </div>
                <div class="breakdown-grid">
                    <div class="breakdown-item">
                        <div id="isOperationalPlot" class="breakdown-plot"></div>
                        <div class="breakdown-label">Probability Operational</div>
                    </div>
                    <div class="operator">×</div>
                    <div class="breakdown-item">
                        <div id="waferStartsPlot" class="breakdown-plot"></div>
                        <div class="breakdown-label">Wafer Starts per Month</div>
                    </div>
                    <div class="operator">×</div>
                    <div class="breakdown-item" style="flex: 0 0 140px; min-width: 140px;">
                        <div id="chipsPerWaferPlot" class="breakdown-plot"></div>
                        <div class="breakdown-label">H100-sized Chips per Wafer</div>
                    </div>
                    <div class="operator">×</div>
                    <div class="breakdown-item">
                        <div id="computePerChipPlot" class="breakdown-plot"></div>
                        <div class="breakdown-label">H100e per Chip (H100 architecture)</div>
                    </div>
                    <div class="operator">×</div>
                    <div class="breakdown-item">
                        <div id="architectureEfficiencyPlot" class="breakdown-plot"></div>
                        <div class="breakdown-label">Architecture Efficiency (relative to H100)</div>
                    </div>
                    <div class="operator">=</div>
                    <div class="breakdown-item">
                        <div id="totalComputePlot" class="breakdown-plot"></div>
                        <div class="breakdown-label">Total H100e per Month</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const runButton = document.getElementById('runSimulation');
        const statusDiv = document.getElementById('status');
        const loadingDiv = document.getElementById('loading');
        const plotsDiv = document.getElementById('plots');

        function setStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }

        function getParameters() {
            return {
                agreement_year: parseFloat(document.getElementById('agreement_year').value),
                end_year: parseFloat(document.getElementById('end_year').value),
                increment: parseFloat(document.getElementById('increment').value),
                num_simulations: parseInt(document.getElementById('num_simulations').value),
                run_covert_project: document.getElementById('run_covert_project').checked,
                build_covert_fab: document.getElementById('build_covert_fab').checked,
                operating_labor: parseInt(document.getElementById('operating_labor').value),
                construction_labor: parseInt(document.getElementById('construction_labor').value),
                process_node: document.getElementById('process_node').value,
                scanner_proportion: parseFloat(document.getElementById('scanner_proportion').value),
                p_project_exists: parseFloat(document.getElementById('p_project_exists').value),
                p_fab_exists: parseFloat(document.getElementById('p_fab_exists').value),
                // Detection parameters
                proportion_of_diverted_sme_with_50p_chance_of_detection: parseFloat(document.getElementById('proportion_diverted_sme').value),
                mean_detection_time_for_100_workers: parseFloat(document.getElementById('mean_detection_time_100').value),
                mean_detection_time_for_1000_workers: parseFloat(document.getElementById('mean_detection_time_1000').value),
                variance_of_detection_time_given_num_workers: parseFloat(document.getElementById('variance_detection_time').value),
                // Production capacity
                wafers_per_month_per_worker: parseFloat(document.getElementById('wafers_per_month_per_worker').value),
                labor_productivity_relative_sigma: parseFloat(document.getElementById('labor_productivity_sigma').value),
                wafers_per_month_per_lithography_scanner: parseFloat(document.getElementById('wafers_per_month_per_scanner').value),
                scanner_productivity_relative_sigma: parseFloat(document.getElementById('scanner_productivity_sigma').value),
                // Construction time
                construction_time_for_5k_wafers_per_month: parseFloat(document.getElementById('construction_time_5k').value),
                construction_time_for_100k_wafers_per_month: parseFloat(document.getElementById('construction_time_100k').value),
                construction_time_relative_sigma: parseFloat(document.getElementById('construction_time_sigma').value),
                construction_workers_per_1000_wafers_per_month: parseFloat(document.getElementById('construction_workers_per_1000').value),
                // Chip production
                h100_sized_chips_per_wafer: parseFloat(document.getElementById('chips_per_wafer').value),
                transistor_density_scaling_exponent: parseFloat(document.getElementById('transistor_density_exponent').value),
                architecture_efficiency_improvement_per_year: parseFloat(document.getElementById('architecture_efficiency').value),
                // PRC scanner production
                prc_lithography_scanners_produced_in_first_year: parseFloat(document.getElementById('prc_scanners_first_year').value),
                prc_additional_lithography_scanners_produced_per_year: parseFloat(document.getElementById('prc_scanners_per_year').value),
                prc_scanner_production_relative_sigma: parseFloat(document.getElementById('prc_scanner_production_sigma').value)
            };
        }

        function plotTimeSeries(data) {
            const ts = data.time_series;

            // Better color scheme
            const probColor = '#5B8DBE'; // Muted blue
            const computeColor = '#9B7BB3'; // Purple

            // Create traces for individual simulations (show first 100 for performance)
            const individualsToShow = Math.min(100, ts.individual_us_probs.length);
            const individualUsProbs = ts.individual_us_probs.slice(0, individualsToShow).map((probs, idx) => ({
                x: ts.years,
                y: probs,
                type: 'scatter',
                mode: 'lines',
                line: { color: probColor, width: 0.8 },
                opacity: 0.08,
                showlegend: false,
                hoverinfo: 'skip'
            }));

            const individualH100e = ts.individual_h100e.slice(0, individualsToShow).map((h100e, idx) => ({
                x: ts.years,
                y: h100e,
                type: 'scatter',
                mode: 'lines',
                line: { color: computeColor, width: 0.8 },
                opacity: 0.08,
                showlegend: false,
                hoverinfo: 'skip',
                yaxis: 'y2'
            }));

            // Median and percentile traces
            const traces = [
                ...individualUsProbs,
                {
                    x: ts.years,
                    y: ts.us_prob_p25,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'transparent' },
                    showlegend: false,
                    hoverinfo: 'skip'
                },
                {
                    x: ts.years,
                    y: ts.us_prob_p75,
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    fillcolor: probColor + '30',
                    line: { color: 'transparent' },
                    name: '25th-75th %ile (Prob)',
                    hovertemplate: 'Prob: %{y:.3f}<extra></extra>'
                },
                {
                    x: ts.years,
                    y: ts.us_prob_median,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: probColor, width: 3 },
                    name: 'Median US Prob',
                    hovertemplate: 'Prob: %{y:.3f}<extra></extra>'
                },
                ...individualH100e,
                {
                    x: ts.years,
                    y: ts.h100e_p25,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'transparent' },
                    showlegend: false,
                    hoverinfo: 'skip',
                    yaxis: 'y2'
                },
                {
                    x: ts.years,
                    y: ts.h100e_p75,
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    fillcolor: computeColor + '30',
                    line: { color: 'transparent' },
                    name: '25th-75th %ile (H100e)',
                    yaxis: 'y2',
                    hovertemplate: 'H100e: %{y:.1f}K<extra></extra>'
                },
                {
                    x: ts.years,
                    y: ts.h100e_median,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: computeColor, width: 3 },
                    name: 'Median H100e',
                    yaxis: 'y2',
                    hovertemplate: 'H100e: %{y:.1f}K<extra></extra>'
                }
            ];

            const layout = {
                xaxis: {
                    title: 'Year',
                    titlefont: { size: 11 },
                    automargin: true
                },
                yaxis: {
                    title: 'US Probability of Covert Fab',
                    titlefont: { size: 11, color: probColor },
                    tickfont: { size: 10, color: probColor },
                    range: [0, 1],
                    side: 'left',
                    automargin: true
                },
                yaxis2: {
                    title: 'H100e Produced by Fab (thousands)',
                    titlefont: { size: 11, color: computeColor },
                    tickfont: { size: 10, color: computeColor },
                    overlaying: 'y',
                    side: 'right',
                    range: [0, 1000],
                    automargin: true
                },
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: -0.25,
                    xanchor: 'left',
                    yanchor: 'top',
                    orientation: 'h',
                    font: { size: 10 }
                },
                hovermode: 'x unified',
                margin: { l: 50, r: 50, t: 10, b: 70, pad: 10 }
            };

            Plotly.newPlot('timeSeriesPlot', traces, layout, {displayModeBar: false, responsive: true});
            setTimeout(() => Plotly.Plots.resize('timeSeriesPlot'), 50);
        }

        function plotComputeCcdf(data) {
            if (!data.compute_ccdfs) {
                document.getElementById('computeCcdfPlot').innerHTML = '<p>No detection data available</p>';
                return;
            }

            const traces = [];
            const thresholds = [
                { value: 0.5, label: 'P(fab) ≥ 50%', color: '#9B7BB3' },  // Purple
                { value: 0.25, label: 'P(fab) ≥ 25%', color: '#5B8DBE' },  // Blue
                { value: 0.125, label: 'P(fab) ≥ 12.5%', color: '#5AA89B' }  // Blue-green
            ];

            for (const threshold of thresholds) {
                const ccdf = data.compute_ccdfs[threshold.value];
                if (ccdf && ccdf.length > 0) {
                    traces.push({
                        x: ccdf.map(d => d.x),
                        y: ccdf.map(d => d.y),
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: threshold.color, width: 2 },
                        name: `"Detection" means ${threshold.label}`,
                        hovertemplate: 'H100e: %{x:.0f}<br>P(≥x): %{y:.3f}<extra></extra>'
                    });
                }
            }

            const layout = {
                xaxis: {
                    title: "H100e Produced by Covert Fab Before 'Detection'",
                    titlefont: { size: 11 },
                    tickfont: { size: 10 },
                    type: 'log',
                    automargin: true
                },
                yaxis: {
                    title: 'P(Compute ≥ x)',
                    titlefont: { size: 11 },
                    tickfont: { size: 10 },
                    range: [0, 1],
                    automargin: true
                },
                showlegend: true,
                legend: {
                    x: 0.98,
                    y: 0.98,
                    xanchor: 'right',
                    yanchor: 'top',
                    bgcolor: 'rgba(255,255,255,0.8)',
                    bordercolor: '#ccc',
                    borderwidth: 1
                },
                hovermode: 'closest',
                margin: { l: 50, r: 50, t: 10, b: 50, pad: 10 }
            };

            Plotly.newPlot('computeCcdfPlot', traces, layout, {displayModeBar: false, responsive: true});
            setTimeout(() => Plotly.Plots.resize('computeCcdfPlot'), 50);
        }

        function plotPDF(divId, values, color, xAxisLabel, nbins = 30, logScale = false) {
            // Create histogram/PDF from values
            const trace = {
                x: values,
                type: 'histogram',
                histnorm: 'probability density',
                marker: { color: color, line: { width: 0.5, color: 'white' } },
                hovertemplate: '%{x:.2f}<br>Density: %{y:.3f}<extra></extra>',
                nbinsx: nbins
            };

            const layout = {
                xaxis: {
                    title: xAxisLabel,
                    titlefont: { size: 10 },
                    automargin: true,
                    tickfont: { size: 9 },
                    type: logScale ? 'log' : 'linear',
                    autorange: true
                },
                yaxis: {
                    title: 'Density',
                    titlefont: { size: 10 },
                    automargin: true,
                    tickfont: { size: 9 }
                },
                showlegend: false,
                margin: { l: 50, r: 50, t: 10, b: 40, pad: 10 },
                hovermode: 'closest'
            };

            Plotly.newPlot(divId, [trace], layout, {displayModeBar: false, responsive: true});
            setTimeout(() => Plotly.Plots.resize(divId), 50);
        }

        function plotMedianWithPercentiles(divId, data, years, color, yAxisLabel = '') {
            // Plot median with 25th-75th percentile bands
            const traces = [];

            // Add individual simulation lines if provided
            if (data.individual) {
                const individualsToPlot = data.individual.slice(0, 100);
                for (let i = 0; i < individualsToPlot.length; i++) {
                    traces.push({
                        x: years,
                        y: individualsToPlot[i],
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: color, width: 0.5 },
                        opacity: 0.08,
                        showlegend: false,
                        hoverinfo: 'skip'
                    });
                }
            }

            // Add percentile bands
            traces.push(
                {
                    x: years,
                    y: data.p25,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: color, width: 1, dash: 'dot' },
                    opacity: 0.4,
                    showlegend: false,
                    hoverinfo: 'skip',
                    name: '25th percentile'
                },
                {
                    x: years,
                    y: data.p75,
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    fillcolor: color + '60',
                    line: { color: color, width: 1, dash: 'dot' },
                    opacity: 0.5,
                    showlegend: false,
                    hoverinfo: 'skip',
                    name: '75th percentile'
                },
                {
                    x: years,
                    y: data.median,
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: color, width: 2.5 },
                    showlegend: false,
                    hovertemplate: 'Year: %{x:.1f}<br>Value: %{y:.2f}<extra></extra>',
                    name: 'Median'
                }
            );

            const layout = {
                xaxis: {
                    title: 'Year',
                    titlefont: { size: 10 },
                    tickfont: { size: 9 },
                    automargin: true,
                    range: [years[0] - 0.1, years[years.length - 1] + 0.1],
                    autorange: false,
                    fixedrange: true
                },
                yaxis: {
                    title: yAxisLabel,
                    titlefont: { size: 10 },
                    tickfont: { size: 9 },
                    automargin: true
                },
                showlegend: false,
                margin: { l: 50, r: 50, t: 10, b: 40, pad: 10 },
                hovermode: 'x'
            };

            Plotly.newPlot(divId, traces, layout, {displayModeBar: false, responsive: true});
            // Force resize after a small delay
            setTimeout(() => Plotly.Plots.resize(divId), 50);
        }

        function plotBarByProcessNode(divId, values, processNodes, color) {
            // Group by process node and compute per wafer value
            const nodeValueCounts = {};
            values.forEach((v, idx) => {
                const rounded = Math.round(v * 1000) / 1000; // Round to 3 decimal places
                const node = processNodes[idx];
                const key = `${rounded}|${node}`;
                nodeValueCounts[key] = (nodeValueCounts[key] || 0) + 1;
            });

            // Parse and sort by value
            const entries = Object.entries(nodeValueCounts).map(([key, count]) => {
                const [value, node] = key.split('|');
                return { value: parseFloat(value), node, count };
            });
            entries.sort((a, b) => a.value - b.value);

            // Convert counts to proportions
            const totalCount = values.length;
            const labels = entries.map(e => `${e.value.toFixed(2)} H100e (${e.node})`);
            const proportions = entries.map(e => e.count / totalCount);

            const trace = {
                x: labels,
                y: proportions,
                type: 'bar',
                marker: {
                    color: color,
                    line: { width: 1, color: 'white' }
                },
                textposition: 'auto',
                hovertemplate: '%{x}<br>Probability: %{y:.3f}<extra></extra>'
            };

            const layout = {
                xaxis: {
                    title: '',
                    titlefont: { size: 10 },
                    tickfont: { size: 9 },
                    automargin: true,
                    type: 'category'
                },
                yaxis: {
                    title: 'Probability',
                    titlefont: { size: 10 },
                    tickfont: { size: 9 },
                    automargin: true
                },
                showlegend: false,
                margin: { l: 50, r: 50, t: 10, b: 50, pad: 10 },
                hovermode: 'closest',
                bargap: 0.2
            };

            Plotly.newPlot(divId, [trace], layout, {displayModeBar: false, responsive: true});
            setTimeout(() => Plotly.Plots.resize(divId), 50);
        }

        function plotProportionOperational(divId, data, years, color, yAxisLabel = '') {
            // Calculate proportion operational at each timestep
            const proportions = data.median; // This is already the proportion since we're averaging 0s and 1s

            const trace = {
                x: years,
                y: proportions,
                type: 'scatter',
                mode: 'lines',
                line: { color: color, width: 2 },
                fill: 'tozeroy',
                fillcolor: color + '20',
                hovertemplate: 'Year: %{x:.1f}<br>Proportion: %{y:.2f}<extra></extra>'
            };

            const layout = {
                xaxis: {
                    title: 'Year',
                    titlefont: { size: 10 },
                    tickfont: { size: 9 },
                    automargin: true,
                    range: [years[0] - 0.1, years[years.length - 1] + 0.1],
                    autorange: false,
                    fixedrange: true
                },
                yaxis: {
                    title: yAxisLabel,
                    range: [0, 1],
                    titlefont: { size: 10 },
                    tickfont: { size: 9 },
                    automargin: true
                },
                showlegend: false,
                margin: { l: 50, r: 50, t: 10, b: 40, pad: 10 },
                hovermode: 'x'
            };

            Plotly.newPlot(divId, [trace], layout, {displayModeBar: false, responsive: true});
            // Force resize after a small delay
            setTimeout(() => Plotly.Plots.resize(divId), 50);
        }

        function plotCategoricalFrequency(divId, values, categories, color) {
            // Count frequencies for each category
            const frequencies = categories.map(cat =>
                values.filter(v => v === cat.value).length
            );

            // Convert to proportions
            const total = values.length;
            const proportions = frequencies.map(f => f / total);

            const trace = {
                x: categories.map(cat => cat.label),
                y: proportions,
                type: 'bar',
                marker: {
                    color: color,
                    line: { width: 1, color: 'white' }
                },
                textposition: 'auto',
                hovertemplate: '%{x}<br>Probability: %{y:.3f}<extra></extra>'
            };

            const layout = {
                xaxis: {
                    title: '',
                    titlefont: { size: 10 },
                    tickfont: { size: 9 },
                    automargin: true,
                    type: 'category'
                },
                yaxis: {
                    title: 'Probability',
                    titlefont: { size: 10 },
                    tickfont: { size: 9 },
                    automargin: true
                },
                showlegend: false,
                margin: { l: 50, r: 50, t: 10, b: 50, pad: 10 },
                hovermode: 'closest',
                bargap: 0.2
            };

            Plotly.newPlot(divId, [trace], layout, {displayModeBar: false, responsive: true});
            setTimeout(() => Plotly.Plots.resize(divId), 50);
        }

        async function runSimulation() {
            runButton.disabled = true;
            loadingDiv.classList.add('active');
            plotsDiv.style.display = 'none';
            setStatus('Running simulation...', 'info');

            try {
                const params = getParameters();
                const response = await fetch('/run_simulation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                });

                if (!response.ok) {
                    throw new Error('Simulation failed');
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Plot main charts
                plotTimeSeries(data);
                plotComputeCcdf(data);

                // Force resize after a brief delay to ensure plots fill containers
                setTimeout(() => {
                    Plotly.Plots.resize('timeSeriesPlot');
                    Plotly.Plots.resize('computeCcdfPlot');
                }, 100);

                // Plot LR breakdown
                if (data.lr_components && data.lr_components.inventory_median) {
                    const years = data.time_series.years;

                    // Get prior probability from parameters and calculate prior odds
                    const priorProb = getParameters().p_fab_exists;
                    const priorOdds = priorProb / (1 - priorProb);

                    // Display prior odds
                    document.getElementById('priorOddsDisplay').innerHTML =
                        `<div style="font-size: 28px; font-weight: bold; color: #555;">${priorOdds.toFixed(3)}</div>`;

                    // LR Inventory - PDF of values across simulations at final timestep
                    const lrInventoryFinal = data.lr_components.inventory_individual.map(sim => sim[sim.length - 1]);
                    console.log('LR Inventory values:', lrInventoryFinal);
                    console.log('LR Inventory min:', Math.min(...lrInventoryFinal), 'max:', Math.max(...lrInventoryFinal));
                    plotPDF('lrInventoryPlot', lrInventoryFinal, '#D97676', 'LR', 10, true);

                    // LR Procurement - Categorical bar plot (1 or 10)
                    const lrProcurementFinal = data.lr_components.procurement_individual.map(sim => sim[sim.length - 1]);
                    plotCategoricalFrequency('lrProcurementPlot', lrProcurementFinal, [
                        { value: 1, label: 'LR = 1 (>90% localization)' },
                        { value: 10, label: 'LR = 10 (≤90% localization)' }
                    ], '#6B9BD1');

                    // LR Other - Median over time with percentiles
                    const lrOtherArray = data.lr_components.other_individual.map(sim => sim.map(v => v));
                    const lrOtherP25 = years.map((_, i) => {
                        const values = lrOtherArray.map(sim => sim[i]);
                        return values.sort((a, b) => a - b)[Math.floor(values.length * 0.25)];
                    });
                    const lrOtherP75 = years.map((_, i) => {
                        const values = lrOtherArray.map(sim => sim[i]);
                        return values.sort((a, b) => a - b)[Math.floor(values.length * 0.75)];
                    });
                    plotMedianWithPercentiles('lrOtherPlot', {
                        median: data.lr_components.other_median,
                        p25: lrOtherP25,
                        p75: lrOtherP75,
                        individual: data.lr_components.other_individual
                    }, years, '#7CAE7A', 'Likelihood Ratio');

                    // Calculate posterior odds (prior odds * total LR) - PDF
                    const posteriorOddsFinal = data.lr_components.inventory_individual.map((invSim, simIdx) => {
                        const i = invSim.length - 1;
                        const totalLR = invSim[i] * data.lr_components.procurement_individual[simIdx][i] * data.lr_components.other_individual[simIdx][i];
                        return priorOdds * totalLR;
                    });
                    plotPDF('posteriorOddsPlot', posteriorOddsFinal, '#9B7BB3', 'Odds');
                }

                // Plot compute breakdown
                if (data.compute_factors && data.compute_factors.is_operational_median) {
                    const years = data.time_series.years;

                    // Proportion Operational - time series showing proportion
                    plotProportionOperational('isOperationalPlot', {
                        median: data.compute_factors.is_operational_median
                    }, years, '#D4A574', 'Probability');

                    // Wafer Starts per Month - PDF
                    const waferStartsFinal = data.compute_factors.wafer_starts_individual.map(sim => sim[sim.length - 1]);
                    plotPDF('waferStartsPlot', waferStartsFinal, '#74B3A8', 'Wafers/Month');

                    // H100-sized Chips per Wafer - Display as a box (constant value)
                    const chipsPerWaferValue = data.compute_factors.chips_per_wafer_individual[0][0]; // Same for all sims
                    document.getElementById('chipsPerWaferPlot').innerHTML = `<div style="display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; color: #555; padding: 20px;">${chipsPerWaferValue.toFixed(0)}</div>`;

                    // H100e per Chip (H100 architecture) - Bar plot at final timestep
                    const computePerChip2022Final = data.compute_factors.compute_per_wafer_2022_arch_individual.map(sim => sim[sim.length - 1]);
                    const processNodes = data.compute_factors.process_node_by_sim;
                    plotBarByProcessNode('computePerChipPlot', computePerChip2022Final, processNodes, '#E8A863');

                    // Architecture Efficiency - median over time with percentiles (smooth curve)
                    if (data.compute_factors.architecture_efficiency_individual && data.compute_factors.architecture_efficiency_individual.length > 0) {
                        const archEffArray = data.compute_factors.architecture_efficiency_individual.map(sim => sim.map(v => v));
                        const archEffP25 = years.map((_, i) => {
                            const values = archEffArray.map(sim => sim[i]).filter(v => v !== undefined && v !== null);
                            if (values.length === 0) return 0;
                            const sorted = values.sort((a, b) => a - b);
                            return sorted[Math.floor(sorted.length * 0.25)];
                        });
                        const archEffP75 = years.map((_, i) => {
                            const values = archEffArray.map(sim => sim[i]).filter(v => v !== undefined && v !== null);
                            if (values.length === 0) return 0;
                            const sorted = values.sort((a, b) => a - b);
                            return sorted[Math.floor(sorted.length * 0.75)];
                        });
                        plotMedianWithPercentiles('architectureEfficiencyPlot', {
                            median: data.compute_factors.architecture_efficiency_median,
                            p25: archEffP25,
                            p75: archEffP75,
                            individual: data.compute_factors.architecture_efficiency_individual
                        }, years, '#A87DC4', 'Efficiency Multiplier');
                    }

                    // Total compute - PDF (at final timestep)
                    const totalComputeFinal = data.compute_factors.is_operational_individual.map((opSim, simIdx) => {
                        const i = opSim.length - 1;
                        return (opSim[i] * data.compute_factors.wafer_starts_individual[simIdx][i] *
                                data.compute_factors.chips_per_wafer_individual[simIdx][i] *
                                data.compute_factors.architecture_efficiency_individual[simIdx][i] *
                                data.compute_factors.compute_per_wafer_2022_arch_individual[simIdx][i]) / 1000;
                    });
                    plotPDF('totalComputePlot', totalComputeFinal, '#B56C6C', 'H100e/Month (K)');
                }

                plotsDiv.style.display = 'block';
                loadingDiv.classList.remove('active');
                setStatus(`Simulation complete! Ran ${data.num_simulations} simulations`, 'success');
            } catch (error) {
                loadingDiv.classList.remove('active');
                setStatus('Error: ' + error.message, 'error');
            } finally {
                runButton.disabled = false;
            }
        }

        runButton.addEventListener('click', runSimulation);

        // Run simulation automatically on page load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(runSimulation, 500); // Small delay to ensure page is fully loaded
        });
    </script>
</body>
</html>
